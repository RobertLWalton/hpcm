#!/bin/sh
#
# Make `Installing HPCM' document.
#
# File:		installing_hpcm
# Author:	Bob Walton (walton@deas.harvard.edu)
# Date:		Mon Sep 11 07:29:28 EDT 2006
#
# The authors have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.
#
# RCS Info (may not be true date or author):
#
#   $Author: walton $
#   $Date: 2006/09/11 11:30:10 $
#   $RCSfile: installing_hpcm,v $
#   $Revision: 1.16 $
#
# The next line starts tcl \
exec tcl "$0" "$@"

# Use tcl rather than tclsh so that `signal' is defined.

# Include common code and parameters:
#
set lib_directory "[file dirname $argv0]/../lib"
source $lib_directory/judging_common.tcl
set log_mode none
catch {

puts "
		     Installing HPCM
		     ---------- ----


Information about HPCM
----------- ----- ----

The web page for HPCM is:

	www.deas.harvard.edu/~hc3/hpcm

There is an overview of HPCM that tells what the system
does.


Installation of HPCM
------------ -- ----

1. Read the `Requirements' section of the Overview docu-
   ment (hpcm/judge/bin/overview) and import if neces-
   sary GNU bash, TCL, JAVA, and CLISP.

2. Create a judging account.

   You may also want to create auxiliary judging ac-
   counts.  An auxiliary judging account can do every-
   thing for a contest that a judging account can do,
   EXCEPT write files in the judging account.  Auxili-
   ary judging accounts are different accounts in the
   same UNIX group as the judging account.

   If you do NOT want auxiliary judging accounts set

   	umask 077

   to make all files and directories in the judging
   account inaccessible to any account but the judging
   account.  If you may want auxiliary judging ac-
   counts, set

   	umask 027

   to make all files and directories in the judging
   account inaccessible except to accounts in the same
   group, and unwritable by other accounts in that
   group.

   If you are using csh, do

   	unset autologout

   to disable autologout.
   
   The following steps are to be carried out in the
   judging account.

3. Import the HPCM system into ~/hpcm.  This can be
   done by untarring the hpcm_*_*.tgz file while the
   current directory is ~ (*_* is the version and sub-
   version; a .tgz file is a gzipped .tar file).
   
   It is also possible to put the hpcm system elsewhere.
   If you do so, be sure a+x permissions are on all
   directories in the path to the hpcm system.  The
   example contests assume HPCM is installed in ~/hpcm,
   but they can be modified if HPCM is installed else-
   where.

   Solutions are distributed as a separate tar file
   named hpcm_*_*_solutions.tgz that can be untarred in
   the ~ directory to add solutions to ~/hpcm.

4. Assuming /sbin is the right directory for secure
   root setuid programs, run:

		cd ~/hpcm/secure/src
		su
		make root_install
		exit

   This installs the hpcm_sandbox program as a setuid
   root program in the system /sbin directory, which
   is the appropriate thing for Linux.  If you put
   this setuid binary in another place, say `/foo',
   you should replace the `make' command above by

		make SECURE_BIN=/foo root_install

   After doing `root_install', create a user account
   named `sandbox'.  This user should never log in (but
   it is harmless if the user does).  Any files owned
   by this user account should be considered insecure.

   If you skip this step, an insecure hpcm_sandbox
   will be installed (in the next step) for the
   judge, which will mean that malicious contestant
   programs could corrupt the judging files.

5. Run		cd ~/hpcm
		make

   This sets some file modes, makes a few binary files,
   and makes the judge's documentation files in hpcm/
   judge/doc.

   If you may also create auxiliary judging accounts,
   run

   		cd ~/hpcm
		make auxiliary

   which sets file modes so programs can be run by auxi-
   liary judges.

   The judge's documentation for any HPCM program is
   made by running the program with the `-doc' option.
   This is done in hpcm/judge/doc to create a .txt docu-
   ment file for each program.  This document, for exam-
   ple, is generated by running `installing_hpcm -doc'.

   There is also significant documentation in the hpcm/
   judge/lib directory files hpcm_judging.rc and *.tcl.

   All the judge's documentation can be printed by
   `make fprint' in hpcm/judge/doc.

   Look at the hpcm/STATUS and hpcm/TODO files to find
   out about deficiencies and changes in the version you
   have gotten.

6. Put ~/hpcm/judge/bin in the PATH of the current
   (judge's) account.  Do NOT put ~/hpcm/contestant/
   bin in that PATH.

7. If you get a new version of HPCM, just repeat steps
   3 and 5.   It may be well to execute

   	mv ~/hpcm ~/hpcm~

   first to save the old hpcm, in case there are any
   differences you want to check later (using diff).
   If the ~/hpcm/secure/src/hpcm_sandbox.c file has
   changed, you will also have to repeat step 4.

8. To make an auxiliary judge account, make the account.
   In the account

   	cd ~
	ln -s ~JUDGES-ACCOUNT judge

   to link ~/judge to the home directory of the judge's
   account.  Then set the account so

   	~/judge/hpcm/judge/bin

   is in the path of the account, and

   	umask 027
	unset autologout

   are affective after logging into the account (as for
   the judge's account in step 2 above).

   Next put the auxiliary judge's account in the same
   group as the judge's account by executing:

   	su
	usermod -G JUDGES-ACCOUNT-GROUP \\
	        AUXILIARY-JUDGES-ACCOUNT
        exit

   The auxiliary judge enters the judging directory by

   	cd ~/judge/judging*

   and thereafter can run `lookat' to find submissions
   and invoke `manualreply' for those submissions."

exit 0

# Include common error catching code:
#
} caught_output
caught_error
