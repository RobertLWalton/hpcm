#! /bin/sh
#
# Test problem code.
#
# File:		testproblems
# Author:	Bob Walton <walton@deas.harvard.edu>
# Date:		Sat Oct  1 05:33:57 EDT 2005
#
# The authors have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.
#
# RCS Info (may not be true date or author):
#
#   $Author: hc3 $
#   $Date: 2005/10/01 09:47:04 $
#   $RCSfile: testproblems,v $
#   $Revision: 1.9 $
#
# The next line starts tcl \
exec tcl "$0" "$@"

set document "
testproblems directory ...

    This program runs:

    		make clean
		make
		diff *.out *.test
		make clean

    in each directory.  It saves the diff outputs in
    addition to outputting them, and then plays back
    all the saved output at the end of this program's
    execution.
    
    If a non-directory is given the program, or if a
    directory with no Makefile is given, the program
    merely notes this in the output."

# If first argument begins with `-doc', print documen-
# tation and exit with error.
#
if { [regexp {^-doc} [lindex $argv 0]] } {
    puts $document
    exit 1
}

set tmp /tmp/testproblems[pid]
file delete -force -- $tmp

signal error {HUP INT QUIT TERM}

catch {

set wd [pwd]
set fd [open $tmp w]

foreach x $argv {

    if { ! [file isdirectory $x] } {
        puts "$x is not a directory"
	continue
    }

    if { ! [file exists $x/Makefile] } {
	puts "$x/Makefile does not exist"
	continue
    }

    puts $fd "========== $x:"
    puts -nonewline "===================="
    puts -nonewline "===================="
    puts -nonewline "===================="
    puts " $x:"

    cd $x
    exec make clean >@ stdout 2>@ stderr
    exec make >@ stdout 2>@ stderr
    catch {
        set diffs [exec diff [glob *.out] [glob *.test]]
          } diffs
    if { [string trim $diffs] != "" } {
	puts $fd $diffs
	puts $diffs
    }
    exec make clean >@ stdout 2>@ stderr
    cd $wd
}
close $fd

puts ""
puts "***** DIFFERENCE SUMMARY *****"
exec cat $tmp >@ stdout
file delete $tmp
exit 0

} out
file delete $tmp
puts $out
exit 1
