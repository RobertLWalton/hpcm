#!/bin/sh
#
# Display scoreboard.
#
# File:		scoreboard
# Author:	Bob Walton <walton@deas.harvard.edu>
# Date:		Fri Feb 13 08:47:00 EST 2004
#
# The authors have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.
#
# RCS Info (may not be true date or author):
#
#   $Author: hc3 $
#   $Date: 2004/02/13 14:09:44 $
#   $RCSfile: scoreboard,v $
#   $Revision: 1.9 $

# Time between refreshes.
#
time=30
debug=no

case "$1" in
    -debug)
        debug=yes
	shift
	;;
esac

# Save contest argument if any and shift it away.
# Also print documentation on -doc* argument.
#
case "$1" in
    -doc*)
    	echo "
scoreboard [-debug] [contest] [page-number] [user]

    Displays each page of the scoreboard for $time sec-
    conds and then repeats, if no page-number is given.
    Otherwise just displays the given page, and re-
    freshes the display every $time seconds.  Pages are
    numbered 1, 2, 3, ..., 8, 9.

    An optional contest can be given for a user that is
    entered in multiple contests.  The user defaults
    to the current account name, and is normally not
    given as a program argument.
    
    Each page is just a file.  If ~/.hpcm_contest/
    scoreboard_map is readable, it consists of lines of
    the form

    	user-regular-expression \\
	    contest-regular-expression \\
	        filename ...

    where the list of filenames gives the files contain-
    ing page 1, page 2, etc. of the scoreboard.  The
    first line whose regular expressions match the
    user and contest names is selected and its list of
    filenames is used.  The user and contest names can
    be given as optional arguments, with the user name
    defaulting to the current account name.  If the
    contest name is not given, it defaults to \`NONE'.
    A contest name cannot be a single digit or have the
    form -doc*.  A user name cannot be a single digit.
    If the a user name is given and no contest name is
    to be given, use NONE for the contest name.

    It is an error if ~/.hpcm_contest/scoreboard_map is
    readable and none of its lines match.

    The \\ backslash character can be used in the
    scoreboard_map file to continue lines.  If a back-
    slash is to be included in the regular expression,
    it must be doubled.  The regular expression is as
    per the \`expr(1)' UNIX command.  This means that
    alternatives are represented by \`\\(a\\|b\\)'
    with a backslash before the (, |, and ).  BUT,
    in the scoreboard_map file THREE backslashes must
    be used before the (, |, or ); the first two to
    get the \\ that expr(1) sees, and the last to pro-
    tect the (, |, ) during the shell read operation.
    Thus one must use \`\\\\\\(a\\\\\\|b\\\\\\)'.

    If ~/.hpcm_contest/scoreboard_map is not readable,
    the filename list defaults to:

        scoreboard.1 scoreboard.2 scoreboard.3 \\
		     scoreboard.4

    File names that do not begin with / are interpreted
    relative to ~/.hpcm_contest.

    The file for page 1 must always be readable, as must
    the file for any page specifically requested.  If
    all pages are to be displayed, any page other than 1
    whose file is unreadable is ignored.
    
    The -debug option prints the expr(1) commands used."

    	exit 1
	;;

    [1-9] )
    	contest=NONE
    	;;
    "" )
    	contest=NONE
	if test $# -gt 1
	then
		shift
	fi
	;;
    *) 	contest="$1"
    	shift
	;;
esac

# Save and shift away any page number argument.
#
case "$1" in
    [1-9])	pn=$1
    		shift ;;
    *)		pn="" ;;
esac

# Compute user name.
#
case "$1" in
    "" )	user=`id -un` ;;
    *)		user="$1" ;;
esac


# Compute pages as list of pages.
#
if test -r "${HOME}/.hpcm_contest/scoreboard_map"
then

    # Open scoreboard map.
    #
    exec 3<"${HOME}/.hpcm_contest/scoreboard_map"

    # Read scoreboard map lines until match found.
    #
    while test x = x
    do
	read <&3 uregexp cregexp page1 page2 page3 \
		 page4 page5 page6 page7 page8 page9

	if test $? -ne 0
	then
	    echo Could not find account \`$user\' \
	         and contest \`$contest\' in \
		 scoreboard_map.
	    exit 1
	fi

	if test $debug == yes
	then
	    echo DEBUG: \
	         expr "$user" : "\\($uregexp\\)\$"
	    echo DEBUG: \
	         expr "$contest" : "\\($cregexp\\)\$"
	fi

	uresult=`expr "$user" : "\\($uregexp\\)\$"`
	cresult=`expr "$contest" : "\\($cregexp\\)\$"`
	if test "$uresult" != "" -a "$cresult" != ""
	then
	    break
	fi
    done

    # Close scoreboard_map file.
    #
    exec 3<&-

else
    page1=scoreboard.1
    page2=scoreboard.2
    page3=scoreboard.3
    page4=scoreboard.4
    page5=""
    page6=""
    page7=""
    page8=""
    page9=""
fi

# Display pages.
#
case "$pn" in
    [1-9] )
    	# Argument is page number.
	#
	eval "page=\"\$page$pn\""
	case "$page" in
	    "")
		echo page $pn does not exist
		exit 1
		;;
	    /*)	;;
	    *)	page=~/.hpcm_contest/$page
	esac
	if test ! -r "$page"
	then
	    echo cannot read "$page"
	    exit 1
	fi

	while test x = x
	do
	    clear
	    cat "$page"
	    sleep $time
	done
	;;
    "" )
        # No page number argument: display all pages.
	# Page 1 must be readable.  Cycle on first
	# empty page name.  Ignore unreadable pages
	# (except for the first).
	#

	while test x = x
	do
	    n=1
	    while test $n -le 9
	    do
		eval "page=\"\$page$n\""
		case "$page" in
		    "")	break ;;
		    /*)	;;
		    *)	page=~/.hpcm_contest/$page
		esac

		if test -r "$page"
		then
		    clear
		    cat "$page"
		    sleep $time
		elif test $n -eq 1
		then
		    echo cannot read "$page"
		    exit 1
		fi
		n=`expr $n + 1`
	    done
	done
	;;
    * )
        # Other argument.
	#
esac

exit 0
