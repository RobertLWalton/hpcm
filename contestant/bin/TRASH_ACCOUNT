#!/bin/sh
#
# Completely reinitialize a contestant account.
#
# File:		TRASH_ACCOUNT
# Author:	Bob Walton <walton@deas.harvard.edu>
# Date:		Mon Sep 25 15:53:55 EDT 2000
#
# The authors have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.
#
# RCS Info (may not be true date or author):
#
#   $Author: hc3 $
#   $Date: 2000/09/26 11:46:03 $
#   $RCSfile: TRASH_ACCOUNT,v $
#   $Revision: 1.7 $

cd

case "$1" in

    "" )
    	if test -x ~/.hpcm_contest
	then
	    contest=`ls -l ~/.hpcm_contest`
	    contest=`expr "$contest" : '.*-> *\([^ ]*\) *$' `
	else
	    echo "
TRASH_ACCOUNT [contest]

    Removes all files from the current account and re-
    loads them from contest/setup.tar.  Checks after re-
    moving files that \`ls -a' equals contest/empty.ls.
    Checks after reloading that \`ls -a' equals contest/
    setup.ls.  Before doing anything, checks that the
    current account name is listed on a line by itself
    in contest/accounts, and also checks that files
    such as contest/home/setup.tar are readable.  If the
    contest argument is not given, it is taken to be the
    target of the symbolic link ~/.hpcm_contest, if that
    exists.  If this program succeeds, it links ~/
    .hpcm_contest to the value of the contest argument."
    	    exit 1
	fi
	;;
    * )
    	contest=$1
	;;
esac

case "$contest" in
    /* )
    	;;
    *)
    	echo $contest is NOT an absolute pathname
	exit 1
    	;;
esac

if test ! -r $contest/home/setup.tar
then
	echo cannot read $contest/setup.tar
	exit 1
elif test ! -r $contest/home/empty.ls
then
	echo cannot read $contest/empty.ls
	exit 1
elif test ! -r $contest/home/setup.ls
then
	echo cannot read $contest/setup.ls
	exit 1
elif test ! -r $contest/accounts
then
	echo cannot read $contest/accounts
	exit 1
fi

grep "^`id -un`\$" $contest/accounts >/dev/null
if test $? -ne 0
then
	echo Bad user `id -un`
	echo Not in $contest/accounts
	exit 1
fi

if test `pwd` != "/home/`id -un`"; then
	echo Home directory is not "/home/`id -un`"
	exit 1
fi

for i in .[a-zA-Z]* *
do
	case $i in
	.snapshot*)
		;;
	*)
		rm -rf $i
	esac
done

echo rm done
ls -a | diff $contest/home/empty.ls -
tar xf $contest/home/setup.tar
echo tar done
ls -aR | diff $contest/home/setup.ls -
rm -f .hpcm_contest
ln -s $contest .hpcm_contest
