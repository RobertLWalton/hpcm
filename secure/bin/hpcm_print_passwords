#! /bin/sh
#
# Print account names and passwords.
#
# File:		hpcm_print_passwords
# Author:	Bob Walton <walton@deas.harvard.edu>
# Date:		Thu Jan  5 08:48:59 EST 2006
#
# The authors have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.
#
# RCS Info (may not be true date or author):
#
#   $Author: hc3 $
#   $Date: 2006/01/05 13:54:05 $
#   $RCSfile: hpcm_print_passwords,v $
#   $Revision: 1.7 $

# If this is not bash and bash is available, switch
# to using bash.  Note that `which bash` may output
# a grubby error message and no error code if bash
# does not exist.  Non-bash sh'es may not handle the
# echo -e option.
#
bash=`which bash 2>/dev/null`
if test "$BASH" = "" -a "$bash" != "" -a -x "$bash"
then
    exec bash "$0" "$@"
fi

case "$1" in
    "" )    ;;
    * )
	    echo "
hpcm_print_passwords | lpr

    Account names and passwords taken from the file
    \`./passwords' are printed.  Each name and password
    is printed on a separate page, prefixed by the
    \`./passwords_header' file.  The hostname for the
    account is that returned by the \`hostname -f' UNIX
    command.  Review the output before printing it by
    replacing \`lpr' by \`more' or \`less'.  If an
    account name or its password is \`none', that
    account is ignored."

	    exit 1
	    ;;
esac

if test ! -r passwords; then
    echo cannot read ./passwords
    exit 1
elif test ! -r passwords_header; then
    echo cannot read ./passwords_header
    exit 1
fi

hostname=`hostname -f`

exec 3< passwords
while read <&3
do
    if expr "$REPLY" : '[ 	]*#' >/dev/null
    then
	continue
    fi
    user=`echo $REPLY | cut -d: -f1`
    password=`echo $REPLY | cut -d: -f2`
    if test "$user" = "none"
    then do_nothing=
    elif test "$password" = "none"
    then do_nothing=
    elif test ! -d /home/$user
    then
    	echo $user has no home directory
	echo -e '\f'
    else
	cat passwords_header
	echo ""
	echo "$user@$hostname      $password"
	echo -e '\f'
    fi
done
exec 3<&-

exit 0
