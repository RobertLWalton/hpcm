#! /bin/sh
#
# Email account names and passwords.
#
# File:		hpcm_email_passwords
# Author:	Bob Walton <walton@deas.harvard.edu>
# Date:		Fri Sep 21 12:18:57 EDT 2001
#
# The authors have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.
#
# RCS Info (may not be true date or author):
#
#   $Author: hc3 $
#   $Date: 2001/09/21 16:12:44 $
#   $RCSfile: hpcm_email_passwords,v $
#   $Revision: 1.2 $

case "$1" in
    -doc* )
	    echo "
hpcm_email_passwords [-execute] [formail-options]

    Account names and passwords taken from the file
    \`./passwords' are emailed to the coaches email
    address taken from the same file.  Each name and
    password is emailed in a separate message, and in
    that message is prefixed by the \`./passwords_
    header' file.  The hostname for the account is that
    returned by the \`hostname' program.

    Without the -execute the messages are sent to the
    standard output, with ending -------- lines, instead
    of being sent to sendmail.  You should carefully
    review the messages before adding the -execute
    option.

    If any formail options are present, the output is
    filtered through formail with these options before
    being sent to sendmail.  For example, the options
    \`-a \"From: fee@fie.fo\"' may be useful to route
    reply messages to another email address than the
    judge's account.

    If an account name or password is \`none', or the
    coaches email address is empty, the account is
    ignored."

	    exit 1
	    ;;
esac

if test ! -r passwords; then
    echo cannot read ./passwords
    exit 1
elif test ! -r passwords_header; then
    echo cannot read ./passwords_header
    exit 1
fi

if test -x /usr/bin/sendmail
then
    sendmail=/usr/bin/sendmail
elif test -x /bin/sendmail
then
    sendmail=/bin/sendmail
elif test -x /usr/sbin/sendmail
then
    sendmail=/usr/sbin/sendmail
elif test -x /sbin/sendmail
then
    sendmail=/sbin/sendmail
else
    echo >&2 cannot find sendmail
fi

mailer=cat
if test "$1" = "-execute"
then
    mailer="$sendmail -oi -t"
    shift
fi

hostname=`hostname`

exec 3< passwords
while read <&3
do
    user=`echo $REPLY | cut -d: -f1`
    password=`echo $REPLY | cut -d: -f2`
    email=`echo $REPLY | cut -d: -f4`

    if test "$user" = "none"
    then do_nothing=
    elif test "$password" = "none"
    then do_nothing=
    elif test "$email" = ""
    then do_nothing=
    elif test ! -d /home/$user
    then
    	echo >&2 $user has no home directory
    elif ( echo "To: $email"; \
           echo "Subject: your account:"; \
	   echo ""; \
	   cat passwords_header; \
	   echo ""; \
	   echo "$user@$hostname      $password"; \
	   echo ""; \
	   echo "--------------------------"; \
	   ) | formail -f "$@" | $mailer
    then do_nothing=
    else
        echo >&2 "ERROR for $user"
    fi
done
exec 3<&-

exit 0
